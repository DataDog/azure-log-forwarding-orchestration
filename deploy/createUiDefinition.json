{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "basics": [
      {
        "name": "infoServicePrincipal",
        "type": "Microsoft.Common.InfoBox",
        "visible": true,
        "options": {
          "icon": "Info",
          "text": "The selection of management group above defines the subscription(s) that will have log forwarding enabled. Any subscriptions within the selected scope, including any subscriptions created in the future, will be automatically discovered and will have logs forwarded. You must have the <b>owner</b> role in the Management Group selected.\n\nThe selection of region, subscription, and resource group defines where the management resources will be deployed. Logs will be forwarded from all subscriptions within the selected management group."
        }
      },
      {
        "name": "armio",
        "type": "Microsoft.Solutions.ArmApiControl",
        "request": {
          "method": "POST",
          "path": "/providers/Microsoft.Management/getEntities?api-version=2020-05-01"
        }
      },
      {
        "name": "subscriptionsID",
        "type": "Microsoft.Common.DropDown",
        "label": "Subscription",
        "toolTip": "Subscription to deploy the Control Plane resources",
        "filterPlaceholder": "Select subscription to deploy the Control Plane resources",
        "filter": true,
        "multiselect": false,
        "selectAll": false,
        "constraints": {
          "allowedValues": "[map(filter(steps('basics').armio.value,(i)=>and(not(equals(i.type, 'Microsoft.Management/managementGroups')),not(and(equals(i.properties.permissions, 'noaccess'),equals(i.properties.inheritedPermissions, 'noaccess')))  )), (item)=> parse(concat('{\"label\":\"', item.properties.displayName, '\",\"value\":\"', item.name, '\"}')))]",
          "required": true
        },
        "visible": true
      },
      {
        "name": "resourceGroup",
        "type": "Microsoft.Common.TextBox",
        "label": "Resource Group Name",
        "toolTip": "Resource Group to deploy the Control Plane resources",
        "defaultValue": "datadog-log-forwarding",
        "placeholder": "datadog-log-forwarding",
        "constraints": {
          "required": true,
          "regex": "^[-\\w\\._\\(\\)]+$",
          "validationMessage": "Must be a valid Resource Group Name"
        },
        "visible": true
      },
      {
        "name": "infoResourceGroup",
        "type": "Microsoft.Common.InfoBox",
        "visible": true,
        "options": {
          "icon": "Warning",
          "text": "This resource group will be used across all subscriptions for the Control Plane and Forwarders. It is reccomended to not re-use an existing resource group name for simpler management and cleanup."
        }
      }
    ],
    "steps": [
      {
        "name": "datadogConfig",
        "label": "Datadog Configuration",
        "elements": [
          {
            "name": "datadogIntegration",
            "type": "Microsoft.Common.Section",
            "label": "Datadog Organization",
            "elements": [
              {
                "name": "textBlock1",
                "type": "Microsoft.Common.TextBlock",
                "visible": true,
                "options": {
                  "text": "To fill out the fields below, copy the API and Application keys from your Datadog org. You can find your API and App Keys in the Access section of the Organization Settings.\n\nAn Application Key is optional, and is only used for reporting metrics about the forwarders to your Datadog org.",
                  "link": {
                    "label": "Learn more",
                    "uri": "https://docs.datadoghq.com/account_management/org_settings/"
                  }
                }
              },
              {
                "name": "datadogApiKey",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Datadog API Key",
                  "confirmPassword": "Re-enter Datadog Api Key"
                },
                "toolTip": "Your Datadog API key",
                "constraints": {
                  "required": true,
                  "validationMessage": "Must be a valid API Key"
                },
                "options": {
                  "hideConfirmation": true
                },
                "visible": true
              },
              {
                "name": "datadogApplicationKey",
                "type": "Microsoft.Common.PasswordBox",
                "label": {
                  "password": "Datadog Application Key",
                  "confirmPassword": "Re-enter Datadog Application Key"
                },
                "toolTip": "Your Datadog Application key",
                "constraints": {
                  "required": false,
                  "validationMessage": "Must be a valid Application Key"
                },
                "options": {
                  "hideConfirmation": true
                },
                "visible": true
              }
            ],
            "visible": true
          },
          {
            "name": "datadogSite",
            "type": "Microsoft.Common.DropDown",
            "label": "Datadog Site",
            "defaultValue": "US1",
            "toolTip": "The datadog site where you usually login. For US3, search for and install the Datadog Resource from the Azure Marketplace instead of using this form",
            "constraints": {
              "allowedValues": [
                {
                  "label": "US1",
                  "value": "datadoghq.com"
                },
                {
                  "label": "US3",
                  "value": "us3.datadoghq.com"
                },
                {
                  "label": "US5",
                  "value": "us5.datadoghq.com"
                },
                {
                  "label": "EU1",
                  "value": "datadoghq.eu"
                },
                {
                  "label": "AP1",
                  "value": "ap1.datadoghq.com"
                },
                {
                  "label": "US1-FED",
                  "value": "ddog-gov.com"
                }
              ],
              "required": false
            },
            "visible": true
          }
        ]
      }
    ],
    "outputs": {
      "controlPlaneLocation": "[location()]",
      "controlPlaneSubscriptionId": "[steps('basics').subscriptionsID]",
      "controlPlaneResourceGroupName": "[steps('basics').resourceGroup]",
      "datadogApplicationKey": "[steps('datadogConfig').datadogIntegration.datadogApplicationKey]",
      "datadogApiKey": "[steps('datadogConfig').datadogIntegration.datadogApiKey]",
      "datadogSite": "[steps('datadogConfig').datadogSite]"
    }
  }
}
